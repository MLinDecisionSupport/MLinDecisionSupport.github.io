<!--HTML-->

<html>
    <image src='oxweb-logo.gif'></image>
  <!--CSS-->
  <link rel="stylesheet" href="Styles.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
 
  <div id='Intro'>
  <head>
 <h1>
  Machine Learning in Prognostic Decision-Support Systems Study
 </h1>
</head>
  <h3>Details</h3>
  <p>
    Thank you for your interest in our study.</br>
    The purpose of the study is to investigate the factors that generate value for the use of Machine Learning models in generating prognostic predictions as part of decision-support systems designed to augment and complement the work of medical professionals and diagnosticians.<br/>
    In particular, we are looking to make Machine Learning algorithms more <i>transparent, explainable</i>, and <i>interpretable</i> by discovering how different model information and Decision-Support system design choices affect the confidence of medical experts in such systems.<br/>
    The study proceeds in two stages:
    <ol>
        <li><b>About the model</b>, which introduces and presents information regarding the <b>Neural Network</b> powering our Decision-Support System</li>
        <li><b>Decision Support</b>, which introduces a mock decision-support system designed to present predicted risk scores for patients</li>
    </ol> 
    
    In this study, we focus on patients who have experienced heart failure, and predict the probability, or risk, of death 1 year after their heart failure event.<br/><br/>
    Please click below for full details before you start the survey.</p>
    <button class = 'showStudyInfo'>Full Study Info</button>
  <div class='studyInfo' style='font-size:75%;'>
    <h5>General Information</h5>
        <p>Machine Learning and Artificial Intelligence models are gaining enthusiasm for their ability to produce highly accurate predictive and analytical insights. However, as many such models, including neural networks, are <i>black-boxes</i>, many fields of practice are reluctant to utilize these models without an ability to interpret their results or understand how a model generates its prediction.</p>
        <p>The aim of this study is to explore this phenomenon and understand what type of model evidence and interpretability modules will increase comprehension and the confidence levels for users in different machine learning predictive models utilized in decision-support systems for prognostics.</p>
        <p>We appreciate your interest in participating in this online survey. You have been invited to participate as an expert in medicine, computer science, or related. Please read through these terms before beginning the survey. You will participate by ticking the <i>Start</i> box below. You may ask any questions before taking part by contacting the researcher (details below).</p>
        <p>We, the University of Oxford, are investigating Machine Learning model interpretability. You will be presented with limited information on a machine learning model, followed by further evidence regrading the model. You will then be asked to rate your confidence level with utilizing the model for predictive purposes and support your answers.</p>
        <p>The full survey should take about 15-20 minutes. No background knowledge is required. Your results will be utilized to determine the best interpretability modules and types of evidence to present to potential users of different machine learning models, and will be collected and utilized by the Computer Science and Engineering Departments at Oxford. <b>No personally identifiable information will be collected or shared</b>.</p>
    <h5>Do I have to take part?</h5>
        <p>Please note that your participation is voluntary. You may withdraw at any point during the questionnaire for any reason, before submitting your answers, by closing the browser. None of your answers will then be collected.</p>
    <h5>How will your data be used?</h5>
        <p>Your answers will be completely anonymous, and we will use all reasonable endeavours to keep them confidential. No personally identifiable, including but not limited to IP address, email address, or name, will be requested or collected.</p>
        <p>Your answers will be stored in a password-protected file and may be used in academic publications. Your IP address will not be stored. Research data will be stored for a minimum of three years after publication or public release.</p>
    <h5>Who will have access to your data?</h5>
        <p>The University of Oxford is the data controller for the purposes of the Data Protection Act 1998.</p>
        <p>We would like your permission to use your unidentifiable data in future studies, and to share data with other researchers (e.g. in online databases).</p>
        <p>Any personal information that could identify you will not be collected or be removed before files are shared with other researchers or results are made public.</p>
        <p>This survey is for an MSc project. The principal researcher is Owen Lahav, who is attached to the Department of Computer Science at the University of Oxford. This project is being completed under the supervision of Mihaela van der Schaar. This project has been reviewed by the University of Oxford’s Department of Computer Science’s Research Ethics Committee.</p>
    <h5>What if there is a problem?</h5>
        <p>If you have a concern about any aspect of this project, please speak to the researcher at oren.lahav@gtc.ox.ac.uk who will do his best to answer your query. The researcher should acknowledge your concern within 10 working days and give you an indication of how they intend to deal with it.</p>
        <p>If you are over 18 and have read the information above and agree to participate with the understanding that the data (including any personal data) you submit will be processed accordingly, please click the ‘Start’ box below to get started. By doing so you will be providing your consent to participate.</p>
  </div>
    <h3>Instructions:</h3>
  <p>
    Please carefully review the information presented and answer the questions on the screen.
    <b>Please do not use the back/forward or refresh buttons once you have started the survey.</b>
  </p>
  <hr>
 </div>

 <div class = 'startQuiz'>
     <h3>Start</h3>
     <p>If you are ready to begin, please press start:</p>
     <button class = 'StartButton'>Start</button>
  </div>

 <div id = 'Rest'></div>

 <div class = 'IntroPart1'>
        <h2><b>Part 1</b>: About the Model</h2>
        <p>On the next screen, you will be presented with information and evidence about the Machine Learning Model that was used to create a decision-support system.</p>
        <p>Please click on the 'Display' button to show each piece of information, and rate how useful you find them.</p>
        <p>Click 'Next' to proceed</p>
        <button class='StartPart1'>Next</button>
 </div>

 <div class = 'Part1'>
    <h2><b>Part 1</b>: About the Model</h2>
    <p>Please consider the following:</p>

    <div class = 'Evidence1'>
        <h3>Data</h3>
        <p>The model was trained using the Meta-analysis Global Group in Chronic Heart Failure (MAGGIC) data-set, which compiled patient data from 30 studies including both randomized clinical trials and observational registries.</p>
        <p>The data set included <b>30,389</b> patients who have experienced a <b>heart failure</b> event. Of these, 18.8% died within 1 year of experiencing heart failure.</p>
        <p>31 patient characteristics were collected, including:</p>
        <ul>
            <li><b>Basic patient details</b>: Age, gender, ethnicity</li>
            <li><b>Patient habits</b>: BMI, Smoking, Diabetes condition</li>
            <li><b>Physical symptoms</b>: Shortness of breath (at rest and exercise), rales</li>
            <li><b>Relevant prescriptions</b>: ACE inhibitors, Beta blockers</li>
            <li><b>Data and test results</b>: Systolic and diastolic blood pressure, ejection fraction, etc.</li>
            <li><b>New York Heart Association Score</b> (Class I-IV)</li>
        </ul>
        <div class = 'E1Q' class='evForm'>
                <p>How useful do you find this information about the model used to generate a decision-support system for heart failure patients?</p>
                <input type='radio' name='E1Q' class='E1Q' class='evForm' value=0> 1: Not useful - I do not understand or care about this information, and it does not impact my opinion of the model or decision-support system<br>
                <input type='radio' name='E1Q' class='E1Q' class='evForm' value=1> 2: Somewhat useful - This information contributes to my understanding and makes me somewhat more confident in the model and decision-support system<br>
                <input type='radio' name='E1Q' class='E1Q' class='evForm' value=2> 3: Very useful - This information improves my understanding and makes me significantly more confident in the model and decision-support system <br><br> 
                <button class = 'evFormButton'>Next</button>
        </div>
    </div>

</div>


 <div class = 'IntroPart2'>
        <h2><b>Part 2</b>: Decision Support System</h2>
        <p>On the next screen, you will be presented with a series of patients.</p>
        <p>Note that these patients were <i>not</i> part of the model's training set, and have been selected <i>at random.</i></p>
        <p>Each patient will be accompanied by a risk score generated using the Neural Network model discussed previously. In addition, medical information about the individual patients will be presented as well.</p>
        <p>Please evaluate this information, and rate your satisfaction with the model and the Decision Support System as a whole.</p>
        <p>Click 'Next' to proceed</p>
        <button class='StartPart2'>Next</button>
 </div>

 <div class = 'Part2'>
     <h2><b>Part 2</b>: Decision Support System</h2>

    <div class = 'Patient1A'>
        <p>Please examine the following patient:</p>
        <p style="text-align:center;"><img src="Adam.png" style="width:50px;"></p>
        <p>Patient <b>Adam</b>, 43-year-old caucasian male, experienced heart failure.<br>Our model predicts that the probability of Adam dying in the next year is <b>15.9%</b>.</p>
        <p>Adam has a BMI of 26.5, and exhibits rales and shortness of breath at exercise.<br>
        The patient has marked limitation of physical activity (New York Heart Association Score Class III).</p>
        <!--<p>Adam showcases an ejection fraction of 19%, his systolic blood pressure is 113, and his diastolic blood pressure is 78.<br>
        His sodium level is 145, and creatine is 64.</p>-->
        <p>Adam has not been prescribed either ACE inhibitors or Beta blockers.</p>
        <p>Adam admits to being an occasional smoker. He does not suffer from diabetes.</p>

        <div class = 'P1AQ' class='patientForm'>
                <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                        <input type='radio' name='P1AQ' class='P1AQ' class='patientForm' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                        <input type='radio' name='P1AQ' class='P1AQ' class='patientForm' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                        <input type='radio' name='P1AQ' class='P1AQ' class='patientForm' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                        <input type='radio' name='P1AQ' class='P1AQ' class='patientForm' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                        <input type='radio' name='P1AQ' class='P1AQ' class='patientForm' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                        <button class = 'patientFormButton'>Next</button>
            </div>
    </div>

    <div class = 'Patient2A'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Betty.png" style="width:50px;"></p>
            <p>Patient <b>Betty</b>, 86-year-old non-caucasian female, experienced heart failure.<br>Our model predicts that the probability of Betty dying in the next year is <b>83.5%</b>.</p>
            <p>Betty has a BMI of 21.6, and exhibits rales and shortness of breath at rest.<br>
            The patient is unable to perform physical activity without discomfort (New York Heart Association Score Class IV).</p>
            <!--<p>Betty showcases an ejection fraction of 36%, her systolic blood pressure is 110, and her diastolic blood pressure is 70.<br>
            Her sodium level is 138, and creatine is 132.6.</p>-->
            <p>Betty has not been prescribed either ACE inhibitors or Beta blockers.</p>
            <p>Betty does not smoke, and does not suffer from diabetes. She does suffer from angina.</p>
    
            <div class = 'P2AQ'>
                    <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                            <input type='radio' name='P2AQ' class='P2AQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                            <input type='radio' name='P2AQ' class='P2AQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                            <input type='radio' name='P2AQ' class='P2AQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                            <input type='radio' name='P2AQ' class='P2AQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                            <input type='radio' name='P2AQ' class='P2AQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                            <button class = 'patientFormButton'>Next</button>
            </div>
    </div>

    <div class = 'Patient3A'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Clara.png" style="width:50px;"></p>
            <p>Patient <b>Clara</b>, 65-year-old caucasian female, experienced heart failure.<br>Our model predicts that the probability of Clara dying in the next year is <b>60.5%</b>.</p>
            <p>Clara has a BMI of 33.4, and exhibits rales and shortness of breath at rest.<br>
                The patient has some limitation of physical activity (New York Heart Association Score Class II).</p>
            <!--<p>Clara showcases an ejection fraction of 42%, her systolic blood pressure is 130, and her diastolic blood pressure is 70.<br>
            Her sodium level is 138, and creatine is 107.</p>-->
            <p>Clara has been prescribed ACE inhibitors.</p>
            <p>Clara is diabetic, and smokes regularly.</p>
    
            <div class = 'P3AQ'>
                    <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                            <input type='radio' name='P3AQ' class='P3AQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                            <input type='radio' name='P3AQ' class='P3AQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                            <input type='radio' name='P3AQ' class='P3AQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                            <input type='radio' name='P3AQ' class='P3AQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                            <input type='radio' name='P3AQ' class='P3AQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                            <button class = 'patientFormButton'>Next</button>
            </div>
    </div>

    <div class = 'Patient4A'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Drew.png" style="width:50px;"></p>
            <p>Patient <b>Drew</b>, a 70-year-old non-caucasian male, experienced heart failure.<br>Our model predicts that the probability of Drew dying in the next year is <b>72.0%</b>.</p>
            <p>Drew has a BMI of 24.2, and exhibits rales and shortness of breath at rest.<br>
                The patient is unable to perform physical activity without discomfort (New York Heart Association Score Class IV).</p>
            <!--<p>Drew showcases an ejection fraction of 33%, her systolic blood pressure is 110, and his diastolic blood pressure is 60.<br>
            His sodium level is 131, and creatine is 135.</p>-->
            <p>Drew has been Not been prescribed ACE inhibitors or Beta blockers.</p>
            <p>Drew is diabetic, but a non-smoker.</p>
    
            <div class = 'P4AQ'>
                    <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                            <input type='radio' name='P4AQ' class='P4AQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                            <input type='radio' name='P4AQ' class='P4AQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                            <input type='radio' name='P4AQ' class='P4AQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                            <input type='radio' name='P4AQ' class='P4AQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                            <input type='radio' name='P4AQ' class='P4AQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                            <button class = 'patientFormButton'>Next</button>
            </div>
    </div>



    <div class = 'Patient1B' class = 'P1B'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Adam.png" style="width:50px;"></p>
            <p>Patient <b>Adam</b>, 43-year-old caucasian male, experienced heart failure.<br>Our model predicts that the probability of Adam dying in the next year is <b>15.9%</b>.</p>
            <p>Adam has a BMI of 26.5, and exhibits rales and shortness of breath at exercise.<br>
            The patient has marked limitation of physical activity (New York Heart Association Score Class III).</p>
            <!--<p>Adam showcases an ejection fraction of 19%, his systolic blood pressure is 113, and his diastolic blood pressure is 78.<br>
            His sodium level is 145, and creatine is 64.</p>-->
            <p>Adam has not been prescribed either ACE inhibitors or Beta blockers.</p>
            <p>Adam admits to being an occasional smoker. He does not suffer from diabetes.</p>

        <button class = 'P1BButton'>Interact with Decision Support System</button>
        <div class = 'Patient1BDSS' class = 'P1B'>
            <p>Examine how the following factors might impact Adam's predicted risk score, based on the Neural Network model utilized:</p>
            <select class = 'P1BS1'>
                    <option value='0'>Smoker</option>
                    <option value='1'>Non-smoker</option>
            </select>
            <select class = 'P1BS2'>
                    <option value='0'>No prescription</option>
                    <option value='1'>ACE Inhibitors</option>
                    <option value='2'>Beta Blockers</option>
            </select>
            <button class = 'P1BPButton'>Calculate</button><br><br>
            Predicted Risk Score: 
            <div class = 'P1BP1'>15.9%</div>
            <div class = 'P1BP2' class = 'P1BP'>12.9%</div>
            <div class = 'P1BP3' class = 'P1BP'>13.4%</div>
            <div class = 'P1BP4' class = 'P1BP'>15.1%</div>
            <div class = 'P1BP5' class = 'P1BP'>12.2%</div>
            <div class = 'P1BP6' class = 'P1BP'>12.6%</div>
        </div>

        <div class = 'P1BQ'>
            <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                    <input type='radio' name='P1BQ' class='P1BQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                    <input type='radio' name='P1BQ' class='P1BQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                    <input type='radio' name='P1BQ' class='P1BQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                    <input type='radio' name='P1BQ' class='P1BQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                    <input type='radio' name='P1BQ' class='P1BQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                    <button class = 'patientFormButton'>Next</button>
        </div>

    </div>

    <div class = 'Patient2B'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Betty.png" style="width:50px;"></p>
            <p>Patient <b>Betty</b>, 86-year-old non-caucasian female, experienced heart failure.<br>Our model predicts that the probability of Betty dying in the next year is <b>83.5%</b>.</p>
            <p>Betty has a BMI of 21.6, and exhibits rales and shortness of breath at rest.<br>
            The patient is unable to perform physical activity without discomfort (New York Heart Association Score Class IV).</p>
            <!--<p>Betty showcases an ejection fraction of 36%, her systolic blood pressure is 110, and her diastolic blood pressure is 70.<br>
            Her sodium level is 138, and creatine is 132.6.</p>-->
            <p>Betty has not been prescribed either ACE inhibitors or Beta blockers.</p>
            <p>Betty does not smoke, and does not suffer from diabetes. She does suffer from angina.</p>
    
            <button class = 'P2BButton'>Interact with Decision Support System</button>
            <div class = 'Patient2BDSS' class = 'P2B'>
                <p>Examine how the following factors might impact Betty's predicted risk score, based on the Neural Network model utilized:</p>
                <select class = 'P2BS1'>
                        <option value='0'>New York Association Score Class IV</option>
                        <option value='1'>New York Association Score Class III</option>
                </select>
                <select class = 'P2BS2'>
                        <option value='0'>No prescription</option>
                        <option value='1'>ACE Inhibitors</option>
                        <option value='2'>Beta Blockers</option>
                </select>
                <button class = 'P2BPButton'>Calculate</button><br><br>
                Predicted Risk Score: 
                <div class = 'P2BP1'>83.5%</div>
                <div class = 'P2BP2' class = 'P2BP'>77.2%</div>
                <div class = 'P2BP3' class = 'P2BP'>77.6%</div>
                <div class = 'P2BP4' class = 'P2BP'>68.4%</div>
                <div class = 'P2BP5' class = 'P2BP'>61.7%</div>
                <div class = 'P2BP6' class = 'P2BP'>62.3%</div>
            </div>

            <div class = 'P2BQ'>
                    <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                            <input type='radio' name='P2BQ' class='P2BQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                            <input type='radio' name='P2BQ' class='P2BQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                            <input type='radio' name='P2BQ' class='P2BQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                            <input type='radio' name='P2BQ' class='P2BQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                            <input type='radio' name='P2BQ' class='P2BQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                            <button class = 'patientFormButton'>Next</button>
            </div>
    </div>

    <div class = 'Patient3B'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Clara.png" style="width:50px;"></p>
            <p>Patient <b>Clara</b>, 54-year-old caucasian female, experienced heart failure.<br>Our model predicts that the probability of Clara dying in the next year is <b>60.5%</b>.</p>
            <p>Clara has a BMI of 33.4, and exhibits rales and shortness of breath at rest.<br>
                The patient has some limitation of physical activity (New York Heart Association Score Class II).</p>
            <!--<p>Clara showcases an ejection fraction of 42%, her systolic blood pressure is 130, and her diastolic blood pressure is 70.<br>
            Her sodium level is 138, and creatine is 107.</p>-->
            <p>Clara has been prescribed ACE inhibitors.</p>
            <p>Clara is diabetic, and smokes regularly.</p>
    
            <button class = 'P3BButton'>Interact with Decision Support System</button>
            <div class = 'Patient3BDSS' class = 'P3B'>
                <p>Examine how the following factors might impact Clara's predicted risk score, based on the Neural Network model utilized:</p>
                <select class = 'P3BS1'>
                        <option value='0'>Smoker</option>
                        <option value='1'>Non-smoker</option>
                </select>
                <select class = 'P3BS2'>
                        <option value='0'>BMI of 33</option>
                        <option value='1'>BMI of 30</option>
                        <option value='2'>BMI of 27</option>
                </select>
                <button class = 'P3BPButton'>Calculate</button><br><br>
                Predicted Risk Score: 
                <div class = 'P3BP1'>60.5%</div>
                <div class = 'P3BP2' class = 'P3BP'>61.0%</div>
                <div class = 'P3BP3' class = 'P3BP'>61.3%</div>
                <div class = 'P3BP4' class = 'P3BP'>54.2%</div>
                <div class = 'P3BP5' class = 'P3BP'>54.6%</div>
                <div class = 'P3BP6' class = 'P3BP'>54.9%</div>
            </div>

            <div class = 'P3BQ'>
                    <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                            <input type='radio' name='P3BQ' class='P3BQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                            <input type='radio' name='P3BQ' class='P3BQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                            <input type='radio' name='P3BQ' class='P3BQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                            <input type='radio' name='P3BQ' class='P3BQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                            <input type='radio' name='P3BQ' class='P3BQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                            <button class = 'patientFormButton'>Next</button>
            </div>
    </div>

    <div class = 'Patient4B'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Drew.png" style="width:50px;"></p>
            <p>Patient <b>Drew</b>, a 70-year-old non-caucasian male, experienced heart failure.<br>Our model predicts that the probability of Drew dying in the next year is <b>72.0%</b>.</p>
            <p>Drew has a BMI of 24.2, and exhibits rales and shortness of breath at rest.<br>
                The patient is unable to perform physical activity without discomfort (New York Heart Association Score Class IV).</p>
            <!--<p>Drew showcases an ejection fraction of 33%, her systolic blood pressure is 110, and his diastolic blood pressure is 60.<br>
            His sodium level is 131, and creatine is 135.</p>-->
            <p>Drew has been Not been prescribed ACE inhibitors or Beta blockers.</p>
            <p>Drew is diabetic, but Drew does does not effectively manage his diabetes. He is a non-smoker.</p>
    
            <button class = 'P4BButton'>Interact with Decision Support System</button>
            <div class = 'Patient4BDSS' class = 'P4B'>
                <p>Examine how the following factors might impact Drew's predicted risk score, based on the Neural Network model utilized:</p>
                <select class = 'P4BS1'>
                        <option value='0'>Diabetes - unmanaged</option>
                        <option value='1'>Diabetes - managed</option>
                </select>
                <select class = 'P4BS2'>
                        <option value='0'>Age 70</option>
                        <option value='1'>Age 80</option>
                </select>
                <button class = 'P4BPButton'>Calculate</button><br><br>
                Predicted Risk Score: 
                <div class = 'P4BP1'>72.0%</div>
                <div class = 'P4BP2' class = 'P4BP'>64.4%</div>
                <div class = 'P4BP3' class = 'P4BP'>77.8%</div>
                <div class = 'P4BP4' class = 'P4BP'>73.9%</div>
            </div>

            <div class = 'P4BQ'>
                    <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                            <input type='radio' name='P4BQ' class='P4BQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                            <input type='radio' name='P4BQ' class='P4BQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                            <input type='radio' name='P4BQ' class='P4BQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                            <input type='radio' name='P4BQ' class='P4BQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                            <input type='radio' name='P4BQ' class='P4BQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                            <button class = 'patientFormButton'>Next</button>
            </div>
    </div>



    <div class = 'Patient1C' class = 'P1C'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Adam.png" style="width:50px;"></p>
            <p>Patient <b>Adam</b>, 43-year-old caucasian male, experienced heart failure.<br>Our model predicts that the probability of Adam dying in the next year is <b>15.9%</b>.</p>
            <p>Adam has a BMI of 26.5, and exhibits rales and shortness of breath at exercise.<br>
            The patient has marked limitation of physical activity (New York Heart Association Score Class III).</p>
            <!--<p>Adam showcases an ejection fraction of 19%, his systolic blood pressure is 113, and his diastolic blood pressure is 78.<br>
            His sodium level is 145, and creatine is 64.</p>-->
            <p>Adam has not been prescribed either ACE inhibitors or Beta blockers.</p>
            <p>Adam admits to being an occasional smoker. He does not suffer from diabetes.</p>

        <button class = 'P1CButton'>Interact with Decision Support System</button>
        <div class = 'Patient1CDSS' class = 'P1C'>
            <p>Examine how the following factors might impact Adam's predicted risk score, based on the Neural Network model utilized:</p>
            <select class = 'P1CS1'>
                    <option value='0'>Smoker</option>
                    <option value='1'>Non-smoker</option>
            </select>
            <select class = 'P1CS2'>
                    <option value='0'>No prescription</option>
                    <option value='1'>ACE Inhibitors</option>
                    <option value='2'>Beta Blockers</option>
            </select>
            <button class = 'P1CPButton'>Calculate</button><br><br>
            Predicted Risk Score: 
            <div class = 'P1CP1'>15.9%</div>
            <div class = 'P1CP2' class = 'P1CP'>12.9%</div>
            <div class = 'P1CP3' class = 'P1CP'>13.4%</div>
            <div class = 'P1CP4' class = 'P1CP'>15.1%</div>
            <div class = 'P1CP5' class = 'P1CP'>12.2%</div>
            <div class = 'P1CP6' class = 'P1CP'>12.6%</div>
        </div>

        <p>Click below to find the patient's status 1 year after the heart failure event</p>
        <button class = 'P1CButton2'>Show Patient Outcome</button>
        <div class=P1CO>
            <p><i>Patient Adam did not die in the year following diagnosis and in fact has survived for 7 years past his initial heart failure event.</i></p>
        </div>

        <div class = 'P1CQ'>
            <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                    <input type='radio' name='P1CQ' class='P1CQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                    <input type='radio' name='P1CQ' class='P1CQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                    <input type='radio' name='P1CQ' class='P1CQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                    <input type='radio' name='P1CQ' class='P1CQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                    <input type='radio' name='P1CQ' class='P1CQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                    <button class = 'patientFormButton'>Next</button>
        </div>

    </div>

    <div class = 'Patient2C'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Betty.png" style="width:50px;"></p>
            <p>Patient <b>Betty</b>, 86-year-old non-caucasian female, experienced heart failure.<br>Our model predicts that the probability of Betty dying in the next year is <b>83.5%</b>.</p>
            <p>Betty has a BMI of 21.6, and exhibits rales and shortness of breath at rest.<br>
            The patient is unable to perform physical activity without discomfort (New York Heart Association Score Class IV).</p>
            <!--<p>Betty showcases an ejection fraction of 36%, her systolic blood pressure is 110, and her diastolic blood pressure is 70.<br>
            Her sodium level is 138, and creatine is 132.6.</p>-->
            <p>Betty has not been prescribed either ACE inhibitors or Beta blockers.</p>
            <p>Betty does not smoke, and does not suffer from diabetes. She does suffer from angina.</p>
    
            <button class = 'P2CButton'>Interact with Decision Support System</button>
            <div class = 'Patient2CDSS' class = 'P2C'>
                <p>Examine how the following factors might impact Betty's predicted risk score, based on the Neural Network model utilized:</p>
                <select class = 'P2CS1'>
                        <option value='0'>New York Association Score Class IV</option>
                        <option value='1'>New York Association Score Class III</option>
                </select>
                <select class = 'P2CS2'>
                        <option value='0'>No prescription</option>
                        <option value='1'>ACE Inhibitors</option>
                        <option value='2'>Beta Blockers</option>
                </select>
                <button class = 'P2CPButton'>Calculate</button><br><br>
                Predicted Risk Score: 
                <div class = 'P2CP1'>83.5%</div>
                <div class = 'P2CP2' class = 'P2CP'>77.2%</div>
                <div class = 'P2CP3' class = 'P2CP'>77.6%</div>
                <div class = 'P2CP4' class = 'P2CP'>68.4%</div>
                <div class = 'P2CP5' class = 'P2CP'>61.7%</div>
                <div class = 'P2CP6' class = 'P2CP'>62.3%</div>
            </div>

            <p>Click below to find the patient's status 1 year after the heart failure event</p>
            <button class = 'P2CButton2'>Show Patient Outcome</button>
            <div class=P2CO>
                <p><i>Patient Betty unfortunately passed away 3 months following her heart failure event.</i></p>
            </div>

            <div class = 'P2CQ'>
                    <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                            <input type='radio' name='P2CQ' class='P2CQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                            <input type='radio' name='P2CQ' class='P2CQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                            <input type='radio' name='P2CQ' class='P2CQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                            <input type='radio' name='P2CQ' class='P2CQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                            <input type='radio' name='P2CQ' class='P2CQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                            <button class = 'patientFormButton'>Next</button>
            </div>
    </div>

    <div class = 'Patient3C'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Clara.png" style="width:50px;"></p>
            <p>Patient <b>Clara</b>, 54-year-old caucasian female, experienced heart failure.<br>Our model predicts that the probability of Clara dying in the next year is <b>60.5%</b>.</p>
            <p>Clara has a BMI of 33.4, and exhibits rales and shortness of breath at rest.<br>
                The patient has some limitation of physical activity (New York Heart Association Score Class II).</p>
            <!--<p>Clara showcases an ejection fraction of 42%, her systolic blood pressure is 130, and her diastolic blood pressure is 70.<br>
            Her sodium level is 138, and creatine is 107.</p>-->
            <p>Clara has been prescribed ACE inhibitors.</p>
            <p>Clara is diabetic, and smokes regularly.</p>
    
            <button class = 'P3CButton'>Interact with Decision Support System</button>
            <div class = 'Patient3CDSS' class = 'P3C'>
                <p>Examine how the following factors might impact Adam's predicted risk score, based on the Neural Network model utilized:</p>
                <select class = 'P3CS1'>
                        <option value='0'>Smoker</option>
                        <option value='1'>Non-smoker</option>
                </select>
                <select class = 'P3CS2'>
                        <option value='0'>BMI of 33</option>
                        <option value='1'>BMI of 30</option>
                        <option value='2'>BMI of 27</option>
                </select>
                <button class = 'P3CPButton'>Calculate</button><br><br>
                Predicted Risk Score: 
                <div class = 'P3CP1'>60.5%</div>
                <div class = 'P3CP2' class = 'P3CP'>61.0%</div>
                <div class = 'P3CP3' class = 'P3CP'>61.3%</div>
                <div class = 'P3CP4' class = 'P3CP'>54.2%</div>
                <div class = 'P3CP5' class = 'P3CP'>54.6%</div>
                <div class = 'P3CP6' class = 'P3CP'>54.9%</div>
            </div>

            <p>Click below to find the patient's status 1 year after the heart failure event</p>
            <button class = 'P3CButton2'>Show Patient Outcome</button>
            <div class=P3CO>
                <p><i>Patient Clara was alive one year after her heart failure event. However, she passed away 2 years later.</i></p>
            </div>

            <div class = 'P3CQ'>
                    <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                            <input type='radio' name='P3CQ' class='P3CQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                            <input type='radio' name='P3CQ' class='P3CQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                            <input type='radio' name='P3CQ' class='P3CQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                            <input type='radio' name='P3CQ' class='P3CQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                            <input type='radio' name='P3CQ' class='P3CQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                            <button class = 'patientFormButton'>Next</button>
            </div>
    </div>

    <div class = 'Patient4C'>
            <p>Please examine the following patient:</p>
            <p style="text-align:center;"><img src="Drew.png" style="width:50px;"></p>
            <p>Patient <b>Drew</b>, a 70-year-old non-caucasian male, experienced heart failure.<br>Our model predicts that the probability of Drew dying in the next year is <b>72.0%</b>.</p>
            <p>Drew has a BMI of 24.2, and exhibits rales and shortness of breath at rest.<br>
                The patient is unable to perform physical activity without discomfort (New York Heart Association Score Class IV).</p>
            <!--<p>Drew showcases an ejection fraction of 33%, her systolic blood pressure is 110, and his diastolic blood pressure is 60.<br>
            His sodium level is 131, and creatine is 135.</p>-->
            <p>Drew has been Not been prescribed ACE inhibitors or Beta blockers.</p>
            <p>Drew is diabetic, but a non-smoker.</p>
    
            <button class = 'P4CButton'>Interact with Decision Support System</button>
            <div class = 'Patient4CDSS' class = 'P4C'>
                <p>Examine how the following factors might impact Adam's predicted risk score, based on the Neural Network model utilized:</p>
                <select class = 'P4CS1'>
                        <option value='0'>Diabetes - unmanaged</option>
                        <option value='1'>Diabetes - managed</option>
                </select>
                <select class = 'P4CS2'>
                        <option value='0'>Age 70</option>
                        <option value='1'>Age 80</option>
                </select>
                <button class = 'P4CPButton'>Calculate</button><br><br>
                Predicted Risk Score: 
                <div class = 'P4CP1'>72.0%</div>
                <div class = 'P4CP2' class = 'P4CP'>77.8%</div>
                <div class = 'P4CP3' class = 'P4CP'>64.4%</div>
                <div class = 'P4CP4' class = 'P4CP'>73.9%</div>
            </div>

            <p>Click below to find the patient's status 1 year after the heart failure event</p>
            <button class = 'P4CButton2'>Show Patient Outcome</button>
            <div class=P4CO>
                <p><i>One year after his heart failure event, Patient Drew was alive. He unfortunately passed away 16 months following his heart failure event.</i></p>
            </div>

            <div class = 'P4CQ'>
                    <p>Based on the information seen so far, how satisfied are you with the Decision Support System powered by a Neural Network model?</p>
                            <input type='radio' name='P4CQ' class='P4CQ' value=0> 1: Completely unsatisfied, not at all likely to use the system in supporting my medical decision-making for heart failure patients<br>
                            <input type='radio' name='P4CQ' class='P4CQ' value=1> 2: Fairly unsatisfied, not likely to use the system<br>
                            <input type='radio' name='P4CQ' class='P4CQ' value=2> 3: Neither satisfied nor unsatisfied, may or may not consult system<br>
                            <input type='radio' name='P4CQ' class='P4CQ' value=3> 4: Somewhat satisfied, likely to at least take a look at the system's prediction<br>
                            <input type='radio' name='P4CQ' class='P4CQ' value=4> 5: Highly satisfied, very likely to consult the system and its prediction as part of my medical decision-making for heart failure patients <br><br> 
                            <button class = 'patientFormButton'>Next</button>
            </div>
    </div>

    

 </div>

<div class='rateML'>
    <h3>Part 3: Reflection</h3>
    <p>Based on both the Model Information seen in Part 1 and the patient scenarios seen in Part 2, please answer the following:</p>
    <p><b>Do you feel that the neural network model presented augments your judgement and constitutes a valuable contribution to decision-support systems?</b></p>
    <form class = 'rateForm'>
        <input type='radio' class='rateML' name='rateML' value=0>Yes<br>
        <input type='radio' class='rateML' name='rateML' value=0>No<br><br>
        Please explain why or why not:
        <textarea comments cols=100 rows=5 placeholder='Details...' class = 'RateMLText' name='RateMLText'></textarea>
        <button class = 'ReflectButton'>Next</button>
    </form>
    <br />
    
</div>

 <div class = 'commentSection'>
    <h3>Comments</h3>
    <p>Please leave any feedback, comments, or concerns about the survey you have just completed.</p>
    <p>In particular, you may address the following:
        <ul>
            <li>What are your general thoughts of Machine Learning in decision-support systems for prognostic predictive purposes?</li>
            <li>Was any of the model evidence and other information shown in Part 1 particularly effective or ineffective? Why?</li>
            <li>Were the patient scenarios helpful in developing your confidence in the underlying model? Why or why not?</li>
            <li>Were there any areas of the survey you felt were confusing or potentially misleading?</li>
        </ul>
    </p>
    <p><b>Important:</b> Do <b>not</b> include any personally identifiable information, such as name or email address, in your answer below.</p>
    <p>You may also email the primary researcher at oren.lahav@gtc.ox.ac.uk.</p>
    <form class = 'commentForm' id = 'Feedback'>
        <textarea comments cols=120 rows=5 placeholder='Feedback:' class='feedbacktext' name='feedbacktext' form = 'Feedback'></textarea>
        <br />
        <button class = 'FeedbackButton'>Submit</button>
    </form>
 </div>

 <div class = 'finished'>
     <h3>Finished!!!</h3>
    <p>
        Thank you very much for taking our survey. Your anonymous results will be used as part of a statistical and ML analysis to determine the best evidence to present to potential users of ML models.<br/>
        We trust that your efforts will be highly significant in helping design Decision-Support systems for prognostic predictions based on Machine Learning models that are useful and make valuable contributions to prognostics and medicine in general.
        Thank you!
    </p>
</div>
 
<!--CODE-->

<!--Setup Firebase-->
<script src="https://www.gstatic.com/firebasejs/5.2.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCJ-RkQ0QfbX_NQrNZ4bQ636jhSiiYH6Ys",
    authDomain: "mldecisionsystem.firebaseapp.com",
    databaseURL: "https://mldecisionsystem.firebaseio.com",
    projectId: "mldecisionsystem",
    storageBucket: "",
    messagingSenderId: "429667121676"
  };
  firebase.initializeApp(config);
</script>

<!--Download jQuery-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<!--Actual code-->
  <script>
    //Setup variables:

    
    var part1 = {
        header : '<b>Part 2:</b> Linear Regression Model',
        description : '<p>The following questions pertain to a <b>Linear regression</b> model, a well-known model historically utilized to generate medical risk scores by statistically estimating coefficients for patient features. The model was trained on a Heart Failure dataset with over 30,000 patients, and utilizes several features to predict the event that a patient suffering heart failure will die within one year.</p><p>Please examine the following scenario and relevant evidence in order and assess your level of confidence in the model after each step.</p>',
        questions : [
            {
                questionText : '<image src="S0Q0O0.png" style="width:700px;"></image><p><h4>For more information:</h4><a href="https://en.wikipedia.org/wiki/Linear_regression">Linear Regression</a></p><br/><p>Given the above only, how confident would you feel using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q1O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q1O1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q2O0.png" style="width:1000px;"></image><p><h4>For more information:</h4><a href="https://en.wikipedia.org/wiki/Cross-validation_(statistics)">Cross-Validation</a><br/><a href="http://www.statisticshowto.com/c-statistic/">C-Statistic</a></p><br/><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q2O1.png" style="width:1000px;"></image><p><h4>For more information:</h4><a href="https://en.wikipedia.org/wiki/Cross-validation_(statistics)">Cross-Validation</a><br/><a href="http://www.statisticshowto.com/c-statistic/">C-Statistic/AUC-ROC</a><br/><a href="https://en.wikipedia.org/wiki/F1_score">F1 Score</a><br/><a href="https://en.wikipedia.org/wiki/Precision_and_recall">Precision and Recall</a></p><br/><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q3O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            }
        ]
    };

    var part2 = {
        header : '<b>Part 3:</b> Neural Network',
        description : '<p>The following questions pertain to a <b>neural network</b>, a sophisticated black-box machine learning model. The model was trained on the same Heart Failure dataset and utilizes several features to predict the event that a patient suffering heart failure will die within one year.</p><p>Please examine the following scenario and relevant evidence in order and assess your level of confidence in the model after each step.</p>',
        questions : [
            {
                questionText : '<image src="S1Q0O0.png" style="width:700px;"></image><p><h4>For more information:</h4><a href="https://en.wikipedia.org/wiki/Neural_network">Neural Network</a></p><br/><p>Given the above only, how confident would you feel using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q1O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q2O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q2O1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q3O0.png" style="width:1000px;"></image><p><h4>For more information:</h4><a href="https://en.wikipedia.org/wiki/Decision_tree_learning">Decision Tree</a></p><br/><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q3O1.png" style="width:1000px;"></image><p><h4>For more information:</h4><a href="https://en.wikipedia.org/wiki/Decision_tree_learning">Decision Tree</a></p><br/><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q4O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            }
        ]
    };

    var part3 = {
        header : '<b>Part 4:</b> Random Forest',
        description : '<p>The following questions pertain to a <b>random forest</b>, a black-box machine learning algorithm that utilizes multiple decision trees. The model was trained on the same Heart Failure dataset and utilizes several features to predict the event that a patient suffering heart failure will die within one year.</p><p>Please examine the following scenario and relevant evidence in order and assess your level of confidence in the model after each step.</p>',
        questions : [
            {
                questionText : '<image src="S2Q0O0.png" style="width:700px;"></image><p><h4>For more information:</h4><a href="https://en.wikipedia.org/wiki/Random_forest">Random Forest</a></p><br/><p>Given the above only, how confident would you feel using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q1O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q2O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q3O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q4O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q4O1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q5O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider looking at model and its prediction when deciding on further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            }
        ]
    };

    var parts = [part1, part2, part3];

    //var answerKey = [0,2];

    var sequenceData = [
        {
            context : 0,
            contextCounter : 0,
            contextData : 
            [
                {
                    section: 1, possibleSequences:[
                        {seqCode:'S0U0', seq: [1,1,0,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U1', seq: [1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U2', seq: [1,0,1,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U3', seq: [1,0,1,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U4', seq: [1,1,0,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U5', seq: [1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U6', seq: [1,0,1,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U7', seq: [1,0,1,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                },
                {
                    section: 2, possibleSequences:[
                        {seqCode:'Part2A', seq : ['A'], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'Part2B', seq : ['B'], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'Part2C', seq : ['C'], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                }
            ]
        },
        {
            context : 1,
            contextCounter : 0,
            contextData : 
            [
            {
                    section: 1, possibleSequences:[
                        {seqCode:'S0U0', seq: [1,1,0,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U1', seq: [1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U2', seq: [1,0,1,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U3', seq: [1,0,1,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U4', seq: [1,1,0,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U5', seq: [1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U6', seq: [1,0,1,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U7', seq: [1,0,1,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                },
                {
                    section: 2, possibleSequences:[
                        {seqCode:'Part2A', seq : ['A'], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'Part2B', seq : ['B'], numTries: 0, currentMean : 2, currentUCB : 10},
                    ]
                }
            ]
        },
        {
            context : 2,
            contextCounter : 0,
            contextData : 
            [
            {
                    section: 1, possibleSequences:[
                        {seqCode:'S0U0', seq: [1,1,0,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U1', seq: [1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U2', seq: [1,0,1,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U3', seq: [1,0,1,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U4', seq: [1,1,0,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U5', seq: [1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U6', seq: [1,0,1,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U7', seq: [1,0,1,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                },
                {
                    section: 2, possibleSequences:[
                        {seqCode:'Part2A', seq : ['A'], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'Part2B', seq : ['B'], numTries: 0, currentMean : 2, currentUCB : 10},
                    ]
                }
            ]
        }
    ];


    var questionCounter = 0;
    var sectionCounter = 0;
    var numContexts = 0;

    //Create function to display a question:
    function displayQuestion(qNum, q)
    {
        var output = [];
        var answersList = [];

        //Setup answers one by one
        for(ans in q.answers)
        {
            ansNum = parseInt(ans) + 1;

            answersList.push(
                '<label class="question question'+qNum+'">'
					+ '<input type="radio" name="question'+qNum+'" class="question'+qNum+'" value="'+ans+'">'
					+ (ansNum) + ': '
					+ q.answers[ans]
				+ '</label><br />'
			    );
		}

        //Push question text and answers
        output.push(
			'<div class="question question'+qNum+'">' + q.questionText + '<br />'
			+ '<div class="answers">' + answersList.join('') + '<br /></div>'
            + '<div value="'+qNum+'" class="button question question'+qNum+'"><button>Next</button></div></div>'
		);
        //console.log(output)

        //Add output to current HTML
        return output;
    }

    function displaySection(sectionNum,section)
    {
        output = [];
        questionList = [];

        //Display ALL questions (we'll hide them later)
        for(var q=0; q<section.questions.length; q++)
        {
           questionList.push(displayQuestion(questionCounter,section.questions[q]));
           questionCounter++;
        }
        
        //Add question list to output and return
        output.push(
            '<div class="section section'+sectionNum+'"><h3>' 
            + section.header 
            +'</h3><p>'
            + section.description
            + '</p>'
            + '<div class="questions">' + questionList.join('') + '</div></div>'
        );

        return output;
    }

    function displayAll(sectionList)
    {
        output = ''
        for(var s = 0; s<sectionList.length;s++)
        {
            output = output+displaySection(sectionCounter,sectionList[s]);
            sectionCounter++;
        }
        return output
    }

    var dbAccesses = 1;
    var dbSeqData;


    //Function to choose, based on UCB, which sequence to show
    function chooseSequence()
    {
        
        //First things first - get latest prob from DB
        var dbRefProbs = firebase.database().ref('Probs');


        //Code to reset probs when we're testing something new - comment out

        returnData = 
                    {
                        name:'X',
                        data:sequenceData,
                        accessCount:0
                    };
                    console.log(returnData);
        
                    //Log the updates
                    dbRefProbs.set(returnData); 

        dbRefProbs.once('value', (response) => {
            
                dbData = response.val().data;
                dbAccesses = response.val().accessCount;
                console.log(dbData);
                console.log('Accesses: '+dbAccesses);

                //For! Each context:

                for (var ctxt = 0; ctxt < dbData.length; ctxt++)
                {
                    contextSeqData = dbData[ctxt].contextData;
                    //console.log('Context Data:')
                    //console.log(contextSeqData)

                    contextSeqToRun = [];
                    contextRunSummary = [];

                    //For! Each section:
                    for (var sect = 0; sect < contextSeqData.length; sect++)
                    {
                        //console.log('Section?');
                        //console.log(sect);
                        //console.log(contextSeqData[sect].possibleSequences);

                        topSeq = [];
                        topCode = '';
                        UCBTrack = 0;

                        possSeqs = contextSeqData[sect].possibleSequences;
                    
                        //Cycle through sequences
                        for (var pSeq = 0; pSeq < possSeqs.length; pSeq++)
                        {
                            //If UCB is higher than the previous one, set this sequence to be chosen
                            if (possSeqs[pSeq].currentUCB >= UCBTrack)
                            {
                                topCode = possSeqs[pSeq].seqCode;
                                topSeq = possSeqs[pSeq].seq;
                                UCBTrack = possSeqs[pSeq].currentUCB;
                            }
                        }

                        contextSeqToRun = contextSeqToRun.concat(topSeq);
                        contextRunSummary.push({
                            sectionNo: contextSeqData[sect].section,
                            seqCode : topCode,
                            seqDesc : topSeq
                        });

                    }



                    seqToRun.push(contextSeqToRun);
                    runSummary.push({contextNo: ctxt, seqData: contextRunSummary});


                }

                console.log('This trial we shall run:')
                console.log(seqToRun);
                console.log(runSummary);
        });
    }


    //Function to update UCB once survey is done

    function updateUBC(resultList, initialSeqData, runSummary, numAccess)
    {
        console.log('UBC Update Step initiate!');
        console.log(initialSeqData);

        //Update total number of accesses
        upAccesses = numAccess + 1;
        upSeqData = [];
        upContextCount = 0;

        for (var ctxt = 0; ctxt < initialSeqData.length; ctxt++)
        {
            currentData = initialSeqData[ctxt];

            if (ctxt != userContext)
            {
                upSeqData.push(currentData);
            }

            else
            {
                console.log('hit context '+ctxt)
                //Set up the updated sequence data vector to return.
                //Section0, the context question, always remains the same:
                qSoFar = 0;

                upContextCount = currentData.contextCounter + 1;
                currentData = currentData.contextData;
                contextUpSeqData = [];

                //For every section
                for(var a = 0; a < currentData.length; a++)
                {
                    sectData = currentData[a];
                    //console.log('sectData');
                    //console.log(sectData);

                    //Find the final confidence score in the model (that's our reward):
                    qSoFar = qSoFar + sectData.possibleSequences[0].seq.length
                    confScore = resultList[qSoFar-1];
                    wloop = qSoFar - 2;
                    while(confScore == -1 && qSoFar >= 0)
                    {
                        confScore = resultList[wloop];
                        wloop = wloop - 1;
                    }

                    //console.log('score?');
                    //console.log(confScore);

                    ranCode = runSummary[userContext].seqData[a].seqCode;
                    //console.log(ranCode);

                    upPossSeq = [];

                    //For each possible sequence:
                    for (var b = 0; b < sectData.possibleSequences.length; b++)
                    {
                        curSeq = sectData.possibleSequences[b];

                        //If we're at the sequence we ran, we must update many things:
                        if (curSeq.seqCode == ranCode)
                        {
                            upTries = curSeq.numTries + 1;
                            upMean = ((curSeq.currentMean*curSeq.numTries) + parseInt(confScore))/upTries;
                            upUCB = upMean + Math.min(Math.sqrt(2*(Math.log(upAccesses)/Math.log(upTries))),10);

                            //Check for NaN:
                            if (isNaN(upUCB) || upTries<=1) {upUCB=10;}
                        }
                        else
                        {
                            upTries = curSeq.numTries;
                            upMean = curSeq.currentMean;
                            upUCB = upMean + Math.min(Math.sqrt(2*(Math.log(upAccesses)/Math.log(upTries))),10);

                            //Check for NaN:
                            if (isNaN(upUCB) || upTries<=1) {upUCB=10;}
                        }

                        upSeq = {
                            seqCode : curSeq.seqCode,
                            seq : curSeq.seq,
                            numTries : upTries,
                            currentMean : upMean,
                            currentUCB : upUCB
                        };

                        //console.log('upSeq');
                        //console.log(upSeq);

                        upPossSeq.push(upSeq);
                    }

                    upSect = {section:a, possibleSequences:upPossSeq};
                    contextUpSeqData.push(upSect);
                    //console.log('upSect')
                    //console.log(upSect)
                    //console.log(contextUpSeqData)
                }

                upSeqData.push({context: ctxt, contextCounter : upContextCount, contextData: contextUpSeqData});                

            }

            
        }
        console.log('Updated UCB Values: ')
        console.log(upSeqData);
        return upSeqData;
    }


    function updateUCBPart2(currentSequences)
    {
        console.log('Lets update UCB Part 2');
        console.log(currentSequences);

        probDataToReturn = [];

        for(ctxt in currentSequences)
        {
            if(currentSequences[ctxt].context == 0)
            {
                ctxtContent = currentSequences[ctxt];
                upAccesses = ctxtContent.contextCounter + 1;
                contextData = ctxtContent.contextData;

                newContextData = []

                for(d in contextData)
                {
                    if(d == 0)
                    {
                        newContextData.push(contextData[d]);
                    }
                    else
                    {
                        ctxtValues = contextData[d].possibleSequences;
                        //console.log(ctxtValues);

                        upPossSeq = [];

                        for(v in ctxtValues)
                        {
                            curSeq = ctxtValues[v];
                        //Update the sequence we're actually at:
                            if(curSeq.seq[0] == part2Seq)
                            {
                                upTries = curSeq.numTries + 1;
                                upMean = ((curSeq.currentMean*curSeq.numTries) + part2FinalAns)/upTries;
                                upUCB = upMean + Math.min(Math.sqrt(2*(Math.log(upAccesses)/Math.log(upTries))),10);

                                //Check for NaN:
                                if (isNaN(upUCB) || upTries<=1) {upUCB=10;}
                            }
                            else
                            {
                                upTries = curSeq.numTries;
                                upMean = curSeq.currentMean;
                                upUCB = upMean + Math.min(Math.sqrt(2*(Math.log(upAccesses)/Math.log(upTries))),10);

                                //Check for NaN:
                                if (isNaN(upUCB) || upTries<=1) {upUCB=10;}
                            }

                            upSeq = {
                            seqCode : curSeq.seqCode,
                            seq : curSeq.seq,
                            numTries : upTries,
                            currentMean : upMean,
                            currentUCB : upUCB
                            };

                            upPossSeq.push(upSeq);
                        }

                        upSect = {possibleSequences:upPossSeq, section:2};
                        newContextData.push(upSect);
                    }
                }
                newProbD = {context:0, contextCounter : upAccesses, contextData : newContextData};

                probDataToReturn.push(newProbD);

            }
            else
            {
                probDataToReturn.push(currentSequences[ctxt]);
            }
        }
        console.log('final UCB');
        console.log(probDataToReturn)

        return probDataToReturn;
    }

    //Variables to store data:
    userContext = 0;
    dataReturn = [];
    whys = [];
    rating = {};
    var initialSeqData;
    var part2Seq;
    part2Ans = [];
    var part2FinalAns;
    seqToRun = [];
    runSummary = [];
    patientsSeen = 0;

    //Set code to run once page is loaded
    $(document).ready(function() {

        //Prepare things to display:
        var pageStuff = document.getElementById('Rest');
        pageContent = displayAll(parts);
        pageStuff.innerHTML = pageStuff.innerHTML + pageContent;

        console.log(pageStuff.innerHTML);

        //Figure out the sequence
        chooseSequence();

        //All the action starts here!

        //Variables:
        interactP1 = 0;
        interactP2 = 0;
        interactP3 = 0;
        interactP4 = 0;
        outcomeP1 = 0;
        outcomeP2 = 0;
        outcomeP3 = 0;
        outcomeP4 = 0;

        //Hide all questions and sections:
        $('.question').hide();
        $('.section').hide();
        $('.finished').hide();
        $('.studyInfo').hide();
        $('.commentSection').hide();
        $('.whyLow').hide();
        $('.whyHigh').hide();
        $('.rateML').hide();
        $('.IntroPart1').hide();
        $('.Part1').hide();
        $('.Evidence1').hide();

        $('.IntroPart2').hide();
        $('.Part2').hide();
        $('.Patient1A').hide();
        $('.Patient1B').hide();
        $('.Patient1BDSS').hide();
        $('.P1BP2').hide();
        $('.P1BP3').hide();
        $('.P1BP4').hide();
        $('.P1BP5').hide();
        $('.P1BP6').hide();
        $('.Patient1C').hide();
        $('.Patient1CDSS').hide();
        $('.P1CP2').hide();
        $('.P1CP3').hide();
        $('.P1CP4').hide();
        $('.P1CP5').hide();
        $('.P1CP6').hide();
        $('.Patient2A').hide();
        $('.Patient2B').hide();
        $('.Patient2BDSS').hide();
        $('.P2BP2').hide();
        $('.P2BP3').hide();
        $('.P2BP4').hide();
        $('.P2BP5').hide();
        $('.P2BP6').hide();
        $('.Patient2C').hide();
        $('.Patient2CDSS').hide();
        $('.P2CP2').hide();
        $('.P2CP3').hide();
        $('.P2CP4').hide();
        $('.P2CP5').hide();
        $('.P2CP6').hide();
        $('.Patient3A').hide();
        $('.Patient3B').hide();
        $('.Patient3BDSS').hide();
        $('.P3BP2').hide();
        $('.P3BP3').hide();
        $('.P3BP4').hide();
        $('.P3BP5').hide();
        $('.P3BP6').hide();
        $('.Patient3C').hide();
        $('.Patient3CDSS').hide();
        $('.P3CP2').hide();
        $('.P3CP3').hide();
        $('.P3CP4').hide();
        $('.P3CP5').hide();
        $('.P3CP6').hide();
        $('.Patient4A').hide();
        $('.Patient4B').hide();
        $('.Patient4BDSS').hide();
        $('.P4BP2').hide();
        $('.P4BP3').hide();
        $('.P4BP4').hide();
        $('.Patient4C').hide();
        $('.Patient4CDSS').hide();
        $('.P4CP2').hide();
        $('.P4CP3').hide();
        $('.P4CP4').hide();
        $('.P4CP5').hide();
        $('.P4CP6').hide();
        $('.P1CO').hide();
        $('.P2CO').hide();
        $('.P3CO').hide();
        $('.P4CO').hide();


        //Show full survey details
        $('.showStudyInfo').on('click', function() {
            $('.studyInfo').toggle();
        })

        //Button Toggles
        $('.P1BButton').on('click', function() {
            $('.Patient1BDSS').toggle();
            interactP1 = 1;
        })

        $('.P2BButton').on('click', function() {
            $('.Patient2BDSS').toggle();
            interactP1 = 1;
        })

        $('.P3BButton').on('click', function() {
            $('.Patient3BDSS').toggle();
            interactP1 = 1;
        })

        $('.P4BButton').on('click', function() {
            $('.Patient4BDSS').toggle();
            interactP1 = 1;
        })

        $('.P1CButton').on('click', function() {
            $('.Patient1CDSS').toggle();
            interactP1 = 1;
        })

        $('.P2CButton').on('click', function() {
            $('.Patient2CDSS').toggle();
            interactP1 = 1;
        })

        $('.P3CButton').on('click', function() {
            $('.Patient3CDSS').toggle();
            interactP1 = 1;
        })

        $('.P4CButton').on('click', function() {
            $('.Patient4CDSS').toggle();
            interactP1 = 1;
        })

        $('.P1CButton2').on('click', function() {
            $('.P1CO').toggle();
            outcomeP1 = 1;
        })   

        $('.P2CButton2').on('click', function() {
            $('.P2CO').toggle();
            outcomeP2 = 1;
        })   

        $('.P3CButton2').on('click', function() {
            $('.P3CO').toggle();
            outcomeP3 = 1;
        })   

        $('.P4CButton2').on('click', function() {
            $('.P4CO').toggle();
            outcomeP4 = 1;
        })        

        $('.P1BPButton').on('click', function() {
            $('.P1BP1').hide();
            $('.P1BP2').hide();
            $('.P1BP3').hide();
            $('.P1BP4').hide();
            $('.P1BP5').hide();
            $('.P1BP6').hide();

            if($('.P1BS1').val()==0)
            {
                if($('.P1BS2').val()==0)
                {
                    $('.P1BP1').show();
                }
                else if($('.P1BS2').val()==1)
                {
                    $('.P1BP2').show();
                }
                else
                {
                    $('.P1BP3').show();
                }
            }
            else
            {
                if($('.P1BS2').val()==0)
                {
                    $('.P1BP4').show();
                }
                else if($('.P1BS2').val()==1)
                {
                    $('.P1BP5').show();
                }
                else
                {
                    $('.P1BP6').show();
                }
            }
        })

        $('.P2BPButton').on('click', function() {
            $('.P2BP1').hide();
            $('.P2BP2').hide();
            $('.P2BP3').hide();
            $('.P2BP4').hide();
            $('.P2BP5').hide();
            $('.P2BP6').hide();

            if($('.PBS2').val()==0)
            {
                if($('.P2BS2').val()==0)
                {
                    $('.P2BP1').show();
                }
                else if($('.P2BS2').val()==1)
                {
                    $('.P2BP2').show();
                }
                else
                {
                    $('.P2BP3').show();
                }
            }
            else
            {
                if($('.P2BS2').val()==0)
                {
                    $('.P2BP4').show();
                }
                else if($('.P2BS2').val()==1)
                {
                    $('.P2BP5').show();
                }
                else
                {
                    $('.P2BP6').show();
                }
            }
        })

        $('.P3BPButton').on('click', function() {
            $('.P3BP1').hide();
            $('.P3BP2').hide();
            $('.P3BP3').hide();
            $('.P3BP4').hide();
            $('.P3BP5').hide();
            $('.P3BP6').hide();

            if($('.P3BS1').val()==0)
            {
                if($('.P3BS2').val()==0)
                {
                    $('.P3BP1').show();
                }
                else if($('.P3BS2').val()==1)
                {
                    $('.P3BP2').show();
                }
                else
                {
                    $('.P3BP3').show();
                }
            }
            else
            {
                if($('.P3BS2').val()==0)
                {
                    $('.P3BP4').show();
                }
                else if($('.P3BS2').val()==1)
                {
                    $('.P3BP5').show();
                }
                else
                {
                    $('.P3BP6').show();
                }
            }
        })

        $('.P4BPButton').on('click', function() {
            $('.P4BP1').hide();
            $('.P4BP2').hide();
            $('.P4BP3').hide();
            $('.P4BP4').hide();

            if($('.P4BS1').val()==0)
            {
                if($('.P4BS2').val()==0)
                {
                    $('.P4BP1').show();
                }
                else
                {
                    $('.P4BP2').show();
                }
            }
            else
            {
                if($('.P4BS2').val()==0)
                {
                    $('.P4BP3').show();
                }
                else
                {
                    $('.P4BP4').show();
                }
            }
        })

        $('.P1CPButton').on('click', function() {
            $('.P1CP1').hide();
            $('.P1CP2').hide();
            $('.P1CP3').hide();
            $('.P1CP4').hide();
            $('.P1CP5').hide();
            $('.P1CP6').hide();

            if($('.P1CS1').val()==0)
            {
                if($('.P1CS2').val()==0)
                {
                    $('.P1CP1').show();
                }
                else if($('.P1CS2').val()==1)
                {
                    $('.P1CP2').show();
                }
                else
                {
                    $('.P1CP3').show();
                }
            }
            else
            {
                if($('.P1CS2').val()==0)
                {
                    $('.P1CP4').show();
                }
                else if($('.P1CS2').val()==1)
                {
                    $('.P1CP5').show();
                }
                else
                {
                    $('.P1CP6').show();
                }
            }
        })

        $('.P2CPButton').on('click', function() {
            $('.P2CP1').hide();
            $('.P2CP2').hide();
            $('.P2CP3').hide();
            $('.P2CP4').hide();
            $('.P2CP5').hide();
            $('.P2CP6').hide();

            if($('.PCS2').val()==0)
            {
                if($('.P2CS2').val()==0)
                {
                    $('.P2CP1').show();
                }
                else if($('.P2CS2').val()==1)
                {
                    $('.P2CP2').show();
                }
                else
                {
                    $('.P2CP3').show();
                }
            }
            else
            {
                if($('.P2CS2').val()==0)
                {
                    $('.P2CP4').show();
                }
                else if($('.P2CS2').val()==1)
                {
                    $('.P2CP5').show();
                }
                else
                {
                    $('.P2CP6').show();
                }
            }
        })

        $('.P3CPButton').on('click', function() {
            $('.P3CP1').hide();
            $('.P3CP2').hide();
            $('.P3CP3').hide();
            $('.P3CP4').hide();
            $('.P3CP5').hide();
            $('.P3CP6').hide();

            if($('.P3CS1').val()==0)
            {
                if($('.P3CS2').val()==0)
                {
                    $('.P3CP1').show();
                }
                else if($('.P3CS2').val()==1)
                {
                    $('.P3CP2').show();
                }
                else
                {
                    $('.P3CP3').show();
                }
            }
            else
            {
                if($('.P3CS2').val()==0)
                {
                    $('.P3CP4').show();
                }
                else if($('.P3CS2').val()==1)
                {
                    $('.P3CP5').show();
                }
                else
                {
                    $('.P3CP6').show();
                }
            }
        })

        $('.P4CPButton').on('click', function() {
            $('.P4CP1').hide();
            $('.P4CP2').hide();
            $('.P4CP3').hide();
            $('.P4CP4').hide();

            if($('.P4CS1').val()==0)
            {
                if($('.P4CS2').val()==0)
                {
                    $('.P4CP1').show();
                }
                else
                {
                    $('.P4CP2').show();
                }
            }
            else
            {
                if($('.P4CS2').val()==0)
                {
                    $('.P4CP3').show();
                }
                else
                {
                    $('.P4CP4').show();
                }
            }
        })



        //Initiate survey:
        $('.startButton').on('click', function(e){
            //Prevent page from refreshing
            e.preventDefault();

            //Register context as 0 (medical expert)
            userContext = 0;

            //Hide Start section
            $('.startQuiz').hide();
            
            //Display the first only to start with
            $('.IntroPart1').show();
            
        });

        //Start Part 1:
        $('.IntroPart1').on('click', function() {
            $('.IntroPart1').hide();
            $('.Part1').show();
            $('.Evidence1').show();
        })

        //Move through Part 1:
        $('.evFormButton').on('click',function(){

            if($('.E1Q').is(':checked'))
            {
                $('.Evidence1').hide();
                $('.IntroPart2').show();

                $('.Part1').hide();
            }
        })


        //Move to Part 2:
        $('.IntroPart2').on('click', function() {
            $('.IntroPart2').hide();

            part2Seq = seqToRun[userContext][6];
            console.log('Part 2 Run Type:')
            console.log(seqToRun[userContext][6]);

            $('.Part2').show();
            $('.patient1'+part2Seq).show();
        })

        //Move to next patient:
        $('.patientFormButton').on('click', function(){

            n = patientsSeen+1;
            q = 'P'+n+part2Seq+'Q'

            if($('.'+q).is(':checked'))
            {
                //e.preventDefault();
                console.log($(':checked','.'+q).val());
                //Prevent page from refreshing
        
                patientsSeen++;
                part2Ans.push($(':checked','.'+q).val());

                if(patientsSeen<4)
                {
                    $('.patient'+patientsSeen+part2Seq).hide();
                    nextPatient = patientsSeen+1;
                    $('.patient'+nextPatient+part2Seq).show();         
                }

                else
                {
                    //Get final answer
                    part2FinalAns = $(':checked','.'+q).val();
                    console.log('Final:');
                    console.log(part2FinalAns);

                    var dbRefProbs = firebase.database().ref('Probs');

                    $('.patient'+patientsSeen+part2Seq).hide();
                    $('.rateML').show();
                }
        }

        });





        //Keep track of what's been answered
        var clicked = 0;
        var questionsInSection = 0;
        var sectionsPassed = 0;

        //Display

        //On click
        $('.button').on('click', function() {

            //Check if an option was selected - otherwise do nothing
            if($('.question'+clicked).is(':checked'))
            {
                var foundNextQuestion = false;
                var round = 0;

                selectedAnswer = $(':checked','.question'+clicked).val();

                //If we need to display a Why-Low (for medical only, not on first question of each section):
                if(userContext == 0 && selectedAnswer < 2 && clicked != 0 && clicked != 6 && clicked != 13)
                {

                    console.log('WHY - Low')

                    $('.question'+clicked).hide();
                    $('.whyLow').attr('checked',false);
                    $('.whyLow').show();

                     $('.whyLow').on('submit', function(e){

                        //Prevent page from refreshing
                        e.preventDefault();

                        $('.whyLow').hide();
                        console.log($('input[name=whyLow]:checked').val());

                        otherReason = '';

                        if($('.whyLowOther').val() != '')
                        {
                            otherReason = $('.whyLowOther').val();
                        }

                        console.log(otherReason);

                        $('.whyLowOther').val('');

                        whys.push('Q'+clicked+'WL'+$('input[name=whyLow]:checked').val()+otherReason);

                        //While we haven't settled on a question to display
                        while(foundNextQuestion == false)
                        {
                            //Check which question and section we're in
                            currentQuestion = '.question'+clicked;
                            currentSection = '.section'+sectionsPassed;

                            //Get the answer, if the user just answered. Otherwise log -1:
                            if(round == 0)
                            {
                                userAnswer = selectedAnswer;
                            }
                            else
                            {
                                userAnswer = -1;
                            }
                            console.log(userAnswer);
                            dataReturn.push(userAnswer);

                            //Check if we're in a new section
                            questionsInSection++;
                            if (questionsInSection==parts[sectionsPassed].questions.length)
                            {
                                sectionsPassed++;
                                questionsInSection = 0;

                                $(currentSection).hide();
                                currentSection = '.section'+sectionsPassed;
                                $(currentSection).show();
                            }

                            //Check if there even is a next question
                            clicked++;
                            nextQuestion = '.question'+clicked;

                            //If not, display finished and exit loop:
                            if(clicked==questionCounter)
                            {
                                $('.rateML').show();

                                console.log(dataReturn);
                                        
                                //Call Firebase
                                var dbRefProbs = firebase.database().ref('Probs');

                                //Redownload Data (so it's fresh, we'll use this newer copy to update UBCs)
                                dbRefProbs.once('value', (response) => {
                                    initialSeqData = response.val().data;
                                });

                                //Exit loop
                                foundNextQuestion = true;
                            }

                            //Otherwise, check whether or not we display next question:
                            else
                            {
                                $(currentQuestion).hide();
                                if(seqToRun[userContext][clicked] == 1)
                                {
                                    $(nextQuestion).show();
                                    foundNextQuestion = true;
                                }

                                //Otherwise, we just increase the round number and loop over to look for the next question  
                            }

                        round++;
                        } 
                     })
                }


                //If we need to display a Why-High (for medical only, not on first question of each section):
                else if(userContext == 0 && selectedAnswer > 2 && clicked != 0 && clicked != 6 && clicked != 13)
                {

                    console.log('WHY - High')

                    $('.question'+clicked).hide();
                    $('.whyHigh').attr('checked',false);
                    $('.whyHigh').show();

                     $('.whyHigh').on('submit', function(e){

                        //Prevent page from refreshing
                        e.preventDefault();

                        $('.whyHigh').hide();
                        console.log($('input[name=whyHigh]:checked').val());

                        otherReason = '';

                        if($('.whyHighOther').val() != '')
                        {
                            otherReason = $('.whyHighOther').val();
                        }

                        console.log(otherReason);

                        $('.whyHighOther').val('');

                        whys.push('Q'+clicked+'WH'+$('input[name=whyHigh]:checked').val()+otherReason);

                        //While we haven't settled on a question to display
                        while(foundNextQuestion == false)
                        {
                            //Check which question and section we're in
                            currentQuestion = '.question'+clicked;
                            currentSection = '.section'+sectionsPassed;

                            //Get the answer, if the user just answered. Otherwise log -1:
                            if(round == 0)
                            {
                                userAnswer = selectedAnswer;
                            }
                            else
                            {
                                userAnswer = -1;
                            }
                            console.log(userAnswer);
                            dataReturn.push(userAnswer);

                            //Check if we're in a new section
                            questionsInSection++;
                            if (questionsInSection==parts[sectionsPassed].questions.length)
                            {
                                sectionsPassed++;
                                questionsInSection = 0;

                                $(currentSection).hide();
                                currentSection = '.section'+sectionsPassed;
                                $(currentSection).show();
                            }

                            //Check if there even is a next question
                            clicked++;
                            nextQuestion = '.question'+clicked;

                            //If not, display finished and exit loop:
                            if(clicked==questionCounter)
                            {
                                $('.rateML').show();

                                console.log(dataReturn);
                                        
                                //Call Firebase
                                var dbRefProbs = firebase.database().ref('Probs');

                                //Redownload Data (so it's fresh, we'll use this newer copy to update UBCs)
                                dbRefProbs.once('value', (response) => {
                                    initialSeqData = response.val().data;
                                });

                                //Exit loop
                                foundNextQuestion = true;
                            }

                            //Otherwise, check whether or not we display next question:
                            else
                            {
                                $(currentQuestion).hide();
                                if(seqToRun[userContext][clicked] == 1)
                                {
                                    $(nextQuestion).show();
                                    foundNextQuestion = true;
                                }

                                //Otherwise, we just increase the round number and loop over to look for the next question  
                            }

                        round++;
                        } 
                     })
                }



                //else - no why: Just move on!
                else
                {    
                    console.log('No Why')

                    //While we haven't settled on a question to display
                    while(foundNextQuestion == false)
                    {
                        //Check which question and section we're in
                        currentQuestion = '.question'+clicked;
                        currentSection = '.section'+sectionsPassed;

                        //Get the answer, if the user just answered. Otherwise log -1:
                        if(round == 0)
                        {
                            userAnswer = selectedAnswer;
                        }
                        else
                        {
                            userAnswer = -1;
                        }
                        console.log(userAnswer);
                        dataReturn.push(userAnswer);

                        //Check if we're in a new section
                        questionsInSection++;
                        if (questionsInSection==parts[sectionsPassed].questions.length)
                        {
                            sectionsPassed++;
                            questionsInSection = 0;

                            $(currentSection).hide();
                            currentSection = '.section'+sectionsPassed;
                            $(currentSection).show();
                        }

                        //Check if there even is a next question
                        clicked++;
                        nextQuestion = '.question'+clicked;

                        //If not, display finished and exit loop:
                        if(clicked==questionCounter)
                        {
                            $('.rateML').show();

                            console.log(dataReturn);
                                        
                            //Call Firebase
                            var dbRefProbs = firebase.database().ref('Probs');

                            //Redownload Data (so it's fresh, we'll use this newer copy to update UBCs)
                            dbRefProbs.once('value', (response) => {
                                initialSeqData = response.val().data;
                            });

                            //Exit loop
                            foundNextQuestion = true;
                        }

                        //Otherwise, check whether or not we display next question:
                        else
                        {
                            $(currentQuestion).hide();
                            if(seqToRun[userContext][clicked] == 1)
                            {
                                $(nextQuestion).show();
                                foundNextQuestion = true;
                            }

                            //Otherwise, we just increase the round number and loop over to look for the next question  
                        }

                    round++;
                    }
                }  
            }              
        })


        //When 'Submit' is clicked (i.e. we're done)

        //Display reflection section
        $('.rateForm').on('submit', function(e){
            //Prevent page from refreshing
            e.preventDefault();

            console.log('Rating')

            console.log($('input[name=rateML]:checked').val());
            console.log($('.rateMLText').val());

            rating = {
                good: $('input[name=rateML]:checked').val(),
                reason: $('.rateMLText').val()
            };

            var dbRefProbs = firebase.database().ref('Probs');

            //Redownload Data (so it's fresh, we'll use this newer copy to update UBCs)
            dbRefProbs.once('value', (response) => {
                initialSeqData = response.val().data;
            });

            $('.rateML').hide();
            $('.commentSection').show();
        })


        //Grab Comments and finish things
        $('.commentForm').on('submit', function(e){
            //Prevent page from refreshing
            e.preventDefault();

            //Get response
            userFeedback = $('.feedbacktext').val();
            console.log('Feedback:');
            console.log(userFeedback);

            //Push results into Firebase DB:
            var dbRef = firebase.database().ref('Results');

            if(whys.length > 0)
            {        
                whyResults = [whys[0]];
                whyCheck = 0;
                for(w = 0; w  < whys.length; w++)
                {
                    if(whys[w].substring(0,3) != whyResults[whyCheck].substring(0,3))
                    {
                        whyResults.push(whys[w]);
                        whyCheck++;
                    }
                }
            }
            else
            {
                whyResults = [];
            }

            //Create result item:
            result = {
                answers : dataReturn,
                context : userContext,
                feedback : userFeedback,
                qSequence : runSummary,
                whys: whyResults,
                rated : rating,
                part2Answers : part2Ans,
                part2Final: part2FinalAns
            };

            console.log('Results recorded:');
            console.log(result);
            console.log('whyResults')
            console.log(whyResults)

            dbRef.push(result);

            //Call the other DBs
            var dbRefProbs = firebase.database().ref('Probs');
            var dbRefProbHist = firebase.database().ref('History');

            //Update probability distributions of future sequences
            var updatedUBC;
            //updatedUBC = updateUBC(dataReturn, initialSeqData, runSummary, dbAccesses);

            var updatedUCB;
            updatedUCB = updateUCBPart2(initialSeqData);

            returnData = 
            {
                name:'X',
                data:updatedUCB,//sequenceData,
                accessCount:dbAccesses+1//0
            };
            console.log(returnData);

            //Log the updates
            dbRefProbs.set(returnData); 
            dbRefProbHist.push(returnData);

            //Hide comments section
            $('.commentSection').hide();
            
            //Display the finished 1section
            $('.finished').show();
        });

    })


  </script>



</html>
